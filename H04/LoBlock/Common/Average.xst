<?xml version='1.0' encoding='utf-8' standalone='yes'?>
<xst path='/$YS/TYPES/LoBlock/Common' m='{"attr":65}'>
  <i n='Average' s='{"cctor":{"LoBlock":"Common/Average"},"Children":{"In":{"ddr":-1,"default":0,"manifest":{"attr":69},"rc":"X1"},"interval":{"default":5000,"manifest":{"attr":69}},"Out":{"default":0,"ddr":1,"manifest":{"attr":65},"rc":"X11"}},"default":"","hint":"Average","icon":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAZdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjAuMjHxIGmVAAAAZklEQVQ4T6WQ2w7AIAhD/f+fZjBk1hsDJTmmLaEPFiK6YhlmWIYZesPWwNyjCT36JlrSxG0BM02kBM00uQKRGfjtCzaMfwOjexMemxLdmfAYC6rXnYk/sOSoQJBDPH4zNCcswzhUHgG+7S9T0SYcAAAAAElFTkSuQmCC","manifest":{"attr":66,"type":"LoBlock/Common/Average"},"namePrefix":"A","src":"class Average{\r\n  constructor(){ \r\n    this.tm = null;\r\n    this.data = [];\r\n    this.Calculate(\"interval\");\r\n    this.Update();\r\n  }\r\n  Calculate(pin){\r\n    if(this.tm==null){\r\n      this.SetState(\"Out\", this.GetState(\"In\"));\r\n    }\r\n    if(pin==\"interval\"){\r\n      if(this.tm != null){\r\n        clearInterval(this.tm); \r\n      }\r\n      let interval = this.GetState(\"interval\");\r\n      if(interval &gt; 0){\r\n        this.tm = setInterval(this.Tick.bind(this), interval);\r\n      }\r\n    } else if(pin==\"In\"){\r\n      this.Update();\r\n    }\r\n  }\r\n  Tick(){\r\n      let interval = this.GetState(\"interval\"), now = (new Date()).getTime(), cur = now, prev = now - interval;\r\n      let sum = 0, i, dt;\r\n      for(i = this.data.length-1; i &gt;= 0 ; i--){\r\n        dt = (this.data[i].t&lt;prev)? (cur - prev) : (cur - this.data[i].t);\r\n        sum+=this.data[i].v*dt;\r\n        if(this.data[i].t&lt;prev){\r\n          break;\r\n        }\r\n        cur = this.data[i].t;\r\n      }\r\n      this.SetState(\"Out\", sum / interval);\r\n      if(this.data.length&gt;1){\r\n        this.data = this.data.slice(-1);\r\n      }\r\n  }\r\n  Update(){\r\n    let vi = this.GetState(\"In\");\r\n    if(typeof(vi)==\"number\" &amp;&amp; !isNaN(vi)){\r\n      this.data.push({\"t\":new Date().getTime(), \"v\":vi});\r\n    }\r\n  }\r\n}","willful":true}' m='{"attr":69,"type":"Ext/LBDescr"}' ver='0.4.1808.6002' />
</xst>